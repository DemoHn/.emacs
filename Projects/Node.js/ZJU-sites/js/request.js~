var links = require("./db");
var req = require("request");
var event = require("events");
var cheerio = require("cheerio");
var u = require("url");

var em = new event.EventEmitter();

var saveLink = function(source_link,opt){
  opt = opt || {};
  opt.uri = source_link;
  opt.method = "GET";
  opt.followRedirect = false;/*强制将跳转关闭*/
  req(opt,function(err,req,body){
    if(err){
//      console.log("CONNECT:"+err);
    }else{
      if(req.statusCode == 200){
  //      console.log("success!");
        var new_link = new links({
          host:source_link,
          ip:"",//TODO 实现对ip地址的记录
          catchTime:new Date(),
          statusCode:200,
          userType:(opt.userType || 0), // 0 代表是机器抓的~~
          title:(opt.title || ""),
          sources:(opt.sources || ""),
          lastUpdated:new Date(),
          status:0
        });

        new_link.save();
        em.emit("req_success",body);
      }
    }
  });
};

var catchUrl = function(body,callback){
  var $ = cheerio.load(body);
  var href_array =[];
  $("a").each(function(i,elem){
    href_array[i] = $(this).attr("href");
  });
  return callback(href_array);
};

// 对url值进行分析.如果符合条件的话则返回0,不符合就返回一些奇怪的东西

var RegUrl = function(host,a_url){
  var qs = u.parse(a_url);
  if(host != qs.host && /zju/.test(qs.host) == true){
    return true;
  }else{
    return false;
  }
};

var diguiGetUrl = function(url,opt){
  saveLink(url,opt);

  var host = u.parse(url).host;
  em.on("req_success",function(body){

    catchUrl(body,function(arr){
      for(var a=0;a<arr.length;a++){
        if(RegUrl(host,arr[a]) == true){
          diguiGetUrl(arr[a],{});
        }
      }
    });

  });
};


diguiGetUrl("http://www.zju.edu.cn",{});
